# 要件定義書 — 予約カレンダー（Laravel + React マイグレーション版）

## 1. プロジェクト概要

### 1.1 目的

大病院の診療予約を Web（スマホ）から簡単に行えるようにする。
電話・窓口の負担を減らし、患者が 3〜5 タップで予約完了できる UX を提供する。

**本プロジェクトは既存の Firebase + Python/FastAPI 版 Reservation-Calendar を
Laravel 12 + React 19（TypeScript）へマイグレーションするものである。**

### 1.2 マイグレーション元

- リポジトリ: https://github.com/kobayashi-Reika7/Reservation-Calendar.git
- 元技術スタック: React 18 + Vite + Firebase Authentication + Firestore + Python/FastAPI
- クローン先: `calendar_temp/`（参照用、マイグレーション完了後に削除）

### 1.3 想定ユーザー

- スマホを利用する患者（20 代〜高齢者）
- IT リテラシーは高くない人も含む → 直感的で分かりやすい UI が必須

### 1.4 利用環境

- スマホ優先・PC 補助
- ブラウザ: Chrome / Safari
- Web アプリ（インストール不要）
- **クラウドサービス不使用**（Firebase 等は使わない。ローカル / オンプレ完結）

---

## 2. 機能要件

### 2.1 ユーザー認証

| 機能 | 内容 |
|------|------|
| ユーザー登録 | メール + パスワード（6 文字以上）。Laravel Sanctum で管理 |
| ログイン | メール + パスワード。トークン発行 |
| ログアウト | トークン無効化 |
| 認証状態保持 | Sanctum SPA 認証。リロード後もログイン状態を保持 |
| 保護ルート | 未ログインで保護画面にアクセス → ログイン画面へリダイレクト |

### 2.2 予約管理

| 機能 | 内容 |
|------|------|
| 予約作成 | 診療科 → 種別（初診/再診）→ 日時選択 → 確認 → 確定 |
| 予約一覧 | ログインユーザーの予約を「今後」「過去」に分けて表示 |
| 予約変更 | 既存予約を編集 → 新規作成 → 旧予約キャンセル（同一トランザクション） |
| 予約キャンセル | 確認ダイアログ → 削除。予約枠を即時解放 |
| 二重予約防止 | DB トランザクション + UNIQUE 制約で同一医師・同一日時の重複を排除 |

### 2.3 空き枠判定

| 機能 | 内容 |
|------|------|
| 日別空き取得 | 指定診療科・日付の全時間枠（15 分刻み）の予約可否を返す |
| 週別空き取得 | 最大 14 日分を一括で取得（バルク最適化） |
| 医師自動割当 | 空いている担当医をバックエンドが自動で割り当てる（ユーザーは選ばない） |
| 祝日判定 | 日本の祝日（固定 + 移動 + 春分/秋分）を判定。祝日は予約不可 |
| 過去日時ブロック | 過去の日付・当日の過ぎた時刻は予約不可 |

### 2.4 マスタデータ

| データ | 内容 |
|--------|------|
| 大分類 | 内科系 / 外科系 / 小児・女性 / 検査 / リハビリ（5 カテゴリ） |
| 診療科 | 14 科（循環器内科、消化器内科、呼吸器内科、腎臓内科、神経内科、整形外科、眼科、耳鼻咽喉科、皮膚科、泌尿器科、小児科、産婦人科、画像診断・検査、臨床検査、リハビリテーション科） |
| 予約目的 | 初診 / 再診（元は 4 種だが、実装は 2 種） |
| 時間枠 | 09:00〜16:45、15 分刻み（32 枠） |
| 担当医 | 17 名。診療科・曜日ごとの勤務スケジュールを保持 |

---

## 3. 非機能要件

| 項目 | 要件 |
|------|------|
| レスポンス | API 応答 500ms 以内（ローカル環境） |
| 同時アクセス | DB トランザクション + UNIQUE 制約で整合性を保証 |
| セキュリティ | Sanctum トークン認証。パスワードは bcrypt ハッシュ。CORS 制限。レートリミット（60req/min） |
| UI/UX | 3〜5 タップで予約完了。フォント 16px 以上。スマホファーストレスポンシブ |
| デザイン | 病院らしい安心感（白・淡いブルー・グリーン）。角丸・余白を十分に。段階的表示 |
| 可用性 | ローカル / オンプレ完結。外部クラウドサービスに依存しない |
| テスト | 認証 → 予約作成 → 一覧 → 変更 → キャンセルの E2E フローが通ること |

---

## 4. 画面一覧

| # | 画面名 | ルート | 認証 | 概要 |
|---|--------|--------|------|------|
| 1 | トップページ | `/` | 不要 | 病院情報・診療科一覧・Web 予約ボタン |
| 2 | ログイン | `/login` | 不要 | メール + パスワード入力 |
| 3 | 新規登録 | `/signup` | 不要 | メール + パスワード入力（6 文字以上） |
| 4 | メニュー | `/menu` | 必要 | 「予約する」「予約を確認する」の選択 |
| 5 | カレンダー | `/calendar` | 必要 | 月表示カレンダー。日付選択 → フォームへ |
| 6 | 予約フォーム | `/reserve/form` | 必要 | 診療科・種別・週ビュー・時間枠選択 |
| 7 | 予約確認 | `/reserve/confirm` | 必要 | 入力内容の確認 → 確定 |
| 8 | 予約一覧 | `/reservations` | 必要 | 今後の予約 / 過去の予約。変更・キャンセル |

---

## 5. 画面遷移

```
[トップ /] ──「Web予約はこちら」──→ [ログイン /login]
                                         │
                              ┌──────────┴──────────┐
                              ↓                      ↓
                    [ログイン成功]           [新規登録 /signup]
                              │                      │
                              ↓                      ↓（登録成功）
                    [メニュー /menu] ←───────────────┘
                       │              │
          「予約する」  │              │ 「予約を確認する」
                       ↓              ↓
              [予約フォーム       [予約一覧
               /reserve/form]     /reservations]
                       │              │
                       ↓              ├─「変更する」→ [予約フォーム]
              [予約確認              └─「キャンセル」→ 確認ダイアログ
               /reserve/confirm]
                       │
                       ↓（確定）
                    完了 → [メニュー /menu]
```

未ログインで保護ルートにアクセスした場合は `/login` へリダイレクト。

---

## 6. 技術スタック

| 区分 | 技術 | バージョン |
|------|------|-----------|
| フロントエンド | React + Vite + TypeScript | React 19 / Vite 7 |
| ルーティング | React Router | 最新 |
| バックエンド | Laravel (PHP) | Laravel 12 / PHP 8.2+ |
| 認証 | Laravel Sanctum | 最新 |
| DB | SQLite（開発）/ MySQL（本番） | SQLite 3 / MySQL 8 |
| ORM | Eloquent | Laravel 同梱 |
| CSS | 独自 CSS（病院テーマ） | - |
| ビルド | Vite | 7.x |

---

## 7. マイグレーション対応表

| 項目 | 移行元（Firebase 版） | 移行先（Laravel 版） |
|------|----------------------|---------------------|
| 認証 | Firebase Authentication | Laravel Sanctum |
| DB | Firestore (NoSQL) | SQLite / MySQL (RDB) |
| バックエンド | Python / FastAPI | Laravel 12 (PHP) |
| フロントエンド | React 18 + JavaScript | React 19 + TypeScript |
| 二重予約防止 | `threading.Lock` + Firestore `create()` | DB トランザクション + UNIQUE 制約 |
| 祝日判定 | Python `_is_japanese_holiday()` | PHP `HolidayService` |
| 医師データ投入 | `seed_doctors.py` + Firestore | `DoctorSeeder` + Eloquent |
| デプロイ | Firebase Hosting | ローカル / オンプレ |

---

## 8. 移行しないもの

以下は Firebase 固有のためマイグレーション対象外とする。

- `.firebaserc` / `firebase.json`（Firebase プロジェクト設定）
- `firestore.rules`（セキュリティルール → Laravel ミドルウェア + Policy で代替）
- `firestore.indexes.json`（複合インデックス → RDB インデックスで代替）
- `firebase_admin_client.py`（Firebase Admin SDK）
- `push-to-Reservation-Calendar.bat`（デプロイ用バッチ）
- `kill_ports.bat`（ポート管理用バッチ）

---

## 9. 制約・前提条件

- クラウドサービスは使用しない（Firebase, AWS, GCP 等）
- 開発環境は Windows（PHP 8.2+、Node.js、Composer がインストール済み前提）
- 既存ワークスペースのパターンを踏襲（`backend/` + `frontend/` 分離、Vite プロキシ）
- 元プロジェクトのビジネスロジック（祝日判定、医師スケジュール、二重予約防止）を完全移植する
