# 要件定義書：コンタクトフォーム（React + Laravel 移行）

## 1. プロジェクト概要

### 1.1 目的
FuelPHP で作成された既存のコンタクトフォームを、**React 19（フロントエンド） + Laravel 12（バックエンド API）** に移行する。

### 1.2 なぜ移行するのか
- **FuelPHP** は開発が停止しており、PHP の新しいバージョンに対応していない
- React + Laravel にすることで、フロント・バック分離による保守性の向上が見込める
- 移行の実践練習として、小規模な実アプリケーションで経験を積む

### 1.3 移行元リポジトリ
- https://github.com/kenjis/sample-contact-form.git
- ローカルパス：`contactform/`

---

## 2. 既存システム分析

### 2.1 フレームワーク
- **FuelPHP**（PHP フレームワーク、2011年頃のコード）

### 2.2 画面構成（4画面）

| # | 画面名 | URL | メソッド | 説明 |
|---|--------|-----|----------|------|
| S-01 | 入力フォーム | `/form/` | GET/POST | フォーム入力画面 |
| S-02 | 確認画面 | `/form/confirm` | POST | 入力内容を確認 |
| S-03 | 送信完了 | `/form/send` | POST | メール送信成功 |
| S-04 | エラー画面 | `/form/error` | - | 送信失敗時 |

### 2.3 フォーム画面遷移

```
[S-01 入力] --確認ボタン--> [S-02 確認] --送信ボタン--> [S-03 完了]
                                |                            |
                            修正ボタン                    エラー時
                                |                            |
                            [S-01 入力]                  [S-04 エラー]
```

### 2.4 フォーム項目

| # | フィールド名 | ラベル | 型 | 必須 | バリデーション |
|---|-------------|--------|-----|------|---------------|
| F-01 | `name` | 名前 | text | ○ | 最大20文字、タブ・改行禁止 |
| F-02 | `email` | メールアドレス | text | ○ | メール形式チェック、タブ・改行禁止 |
| F-03 | `comment` | コメント | textarea | ○ | 最大400文字 |
| F-04 | `gender` | 性別 | radio | × | 選択肢：男性 / 女性 |
| F-05 | `kind` | 問い合わせの種類 | select | × | 選択肢：（空）/ 製品購入前のお問い合わせ / 製品購入後のお問い合わせ / その他 |
| F-06 | `lang` | 使用プログラミング言語 | checkbox | × | 選択肢：PHP / Perl / Python（複数選択可） |

### 2.5 セキュリティ対策（既存）

| 対策 | 内容 |
|------|------|
| CSRF | トークンによる検証（確認→送信間） |
| XSS | 出力時の htmlentities エスケープ |
| 入力フィルタ | UTF-8 エンコーディング検証、制御文字ブロック、改行正規化 |
| メールヘッダインジェクション | From/To/Subject の `\r\n` 検証 |
| クリックジャッキング | `X-FRAME-OPTIONS: SAMEORIGIN` ヘッダ |

### 2.6 メール送信設定

```
宛先名：管理者
宛先メール：admin@example.jp
件名：コンタクトフォーム
送信方法：PHP mail() 関数
```

### 2.7 メール本文フォーマット

```
====================
名前: {name}
メールアドレス: {email}
IPアドレス: {ip}
ブラウザ: {user_agent}
====================
コメント:
{comment}

性別: {gender}
問い合わせの種類: {kind}
使用プログラミング言語: {lang}
====================
```

---

## 3. 新システム要件

### 3.1 技術スタック

| レイヤー | 技術 | バージョン |
|---------|------|-----------|
| フロントエンド | React | 19 |
| ビルドツール | Vite | 最新 |
| バックエンド | Laravel | 12 |
| 言語（FE） | TypeScript | 最新 |
| 言語（BE） | PHP | 8.2+ |
| 通信 | REST API（JSON） | - |

### 3.2 機能要件

#### 3.2.1 フォーム入力（React）
- 6項目のフォームを SPA で表示する
- リアルタイムバリデーション（入力中にエラーを表示）
- 既存と同じバリデーションルールを適用する

#### 3.2.2 確認画面（React）
- 入力内容を一覧表示する
- 「修正」ボタンで入力画面に戻れる（入力値を保持）
- 「送信」ボタンで API に送信する

#### 3.2.3 送信完了画面（React）
- 送信成功のメッセージを表示する
- 「最初に戻る」リンクでフォームに戻れる

#### 3.2.4 エラー画面（React）
- 送信失敗のメッセージとエラー内容を表示する
- 「戻る」ボタンで入力画面に戻れる

#### 3.2.5 送信 API（Laravel）
- `POST /api/contact` でフォームデータを受け取る
- サーバー側でもバリデーションを実行する（フロントと同じルール）
- バリデーション通過後、メールを送信する
- 成功/失敗をJSON で返却する

### 3.3 API 仕様

#### POST /api/contact

**リクエスト**
```json
{
  "name": "田中太郎",
  "email": "tanaka@example.com",
  "comment": "お問い合わせ内容です",
  "gender": "男性",
  "kind": "製品購入前のお問い合わせ",
  "lang": ["PHP", "Python"]
}
```

**レスポンス（成功）**
```json
{
  "success": true,
  "message": "お問い合わせを送信しました"
}
```

**レスポンス（バリデーションエラー）**
```json
{
  "success": false,
  "message": "入力内容にエラーがあります",
  "errors": {
    "name": ["名前は必須です"],
    "email": ["有効なメールアドレスを入力してください"]
  }
}
```

**レスポンス（送信エラー）**
```json
{
  "success": false,
  "message": "メールの送信に失敗しました"
}
```

### 3.4 非機能要件

| 項目 | 要件 |
|------|------|
| セキュリティ | 既存と同等以上（XSS, CSRF, メールヘッダインジェクション対策） |
| バリデーション | フロント（UX向上） + バック（セキュリティ）の二重チェック |
| レスポンシブ | スマートフォンでも使えるデザイン |
| 言語 | 日本語（UI / バリデーションメッセージ） |
| メール | 既存と同じフォーマットで管理者に送信 |

### 3.5 バリデーションルール（詳細）

| フィールド | ルール | エラーメッセージ |
|-----------|--------|----------------|
| `name` | 必須、最大20文字、タブ・改行禁止 | 「名前は必須です」「名前は20文字以内で入力してください」 |
| `email` | 必須、メール形式 | 「メールアドレスは必須です」「有効なメールアドレスを入力してください」 |
| `comment` | 必須、最大400文字 | 「コメントは必須です」「コメントは400文字以内で入力してください」 |
| `gender` | 許可値のみ（男性/女性） | 「無効な選択肢です」 |
| `kind` | 許可値のみ | 「無効な選択肢です」 |
| `lang` | 許可値のみ（PHP/Perl/Python） | 「無効な選択肢です」 |

---

## 4. 画面設計

### S-01：入力フォーム
- ヘッダー：「コンタクトフォーム」
- 6つの入力項目（既存と同じ）
- 必須項目にはマーク（*）を表示
- 入力エラーは各フィールド直下にリアルタイム表示
- 「確認」ボタン

### S-02：確認画面
- ヘッダー：「入力内容の確認」
- 入力内容を一覧で読みやすく表示
- 「修正する」ボタン → 入力画面に戻る（値保持）
- 「送信する」ボタン → API 送信

### S-03：送信完了画面
- 「お問い合わせを送信しました」メッセージ
- 「最初に戻る」リンク

### S-04：エラー画面
- 「送信に失敗しました」メッセージ
- エラー内容の表示
- 「戻る」ボタン

---

## 5. 移行フェーズ

| Phase | 内容 | 作業 |
|-------|------|------|
| Phase 1 | 環境構築 | Laravel 12 + React 19 プロジェクト作成 |
| Phase 2 | Laravel API | FormRequest, Controller, メール送信, テスト |
| Phase 3 | React フロントエンド | フォーム, 確認画面, 完了/エラー画面 |
| Phase 4 | 結合テスト | フロント⇔バック結合確認 |

---

## 6. 制約事項

- メール送信は `MAIL_MAILER=log`（ログ出力）で開発・テストする（実際のSMTPサーバーは不要）
- 既存の `contactform/` フォルダは参照用として残す
- 新しいプロジェクトは `backend/`（Laravel）と `frontend/`（React）に作成する
- XAMPP の PHP（`C:\xampp\php\php.exe`）を使用する

---

_作成日: 2026-02-18_
